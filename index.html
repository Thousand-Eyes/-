<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç£äººç”Ÿè²¡å‹™æ¨¡æ“¬å™¨ v7.4.1 (åœ“é¤…åœ–ä¿®æ­£ç‰ˆ)</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .chart-container { position: relative; width: 100%; height: 100%; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .prose h3 { font-size: 1.1em; font-weight: bold; margin-bottom: 0.5em; color: #1e293b; }
        .prose ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.5em; }
        .prose li { margin-bottom: 0.2em; }
        .prose strong { color: #2563eb; }
        .prose p { margin-bottom: 0.8em; }
        @keyframes sparkle {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }
        .ai-pulse { animation: sparkle 2s infinite ease-in-out; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans selection:bg-blue-100">

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef, useMemo } = React;

    const apiKey = ""; 

    const callGeminiAPI = async (prompt) => {
        try {
            const maxRetries = 3;
            let attempt = 0;
            while (attempt < maxRetries) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "AI æš«æ™‚ç„¡æ³•å›æ‡‰ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
                } catch (err) {
                    attempt++;
                    if (attempt === maxRetries) throw err;
                    await new Promise(r => setTimeout(r, 1000 * Math.pow(2, attempt)));
                }
            }
        } catch (error) {
            console.error("Gemini API Failed:", error);
            return "é€£ç·šç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– API Keyã€‚";
        }
    };

    const calculateLoan = (priceWan, downPaymentPercent, years, ratePercent) => {
        const totalLoan = priceWan * 10000 * (1 - downPaymentPercent / 100);
        const monthlyRate = (ratePercent / 100) / 12;
        const months = years * 12;
        let monthlyPayment = 0;
        if (monthlyRate > 0) {
            monthlyPayment = (totalLoan * monthlyRate * Math.pow(1 + monthlyRate, months)) / (Math.pow(1 + monthlyRate, months) - 1);
        } else {
            monthlyPayment = totalLoan / months;
        }
        return { monthly: Math.round(monthlyPayment), daily: Math.round(monthlyPayment / 30), totalLoan };
    };

    const coreSimulation = (data) => {
        const { params, properties, cars, childrenList, passiveIncomes, customExpenses } = data;
        let age = params.currentAge;
        let nominalAssets = params.currentAssets * 10000;
        let currentMonthlyWage = params.monthlyIncome * 10000;
        
        // --- ä¿®æ­£é–‹å§‹ï¼šå¼·åˆ¶è½‰å‹ç‚º Number ä»¥ç¢ºä¿é‹ç®—é‚è¼¯æ­£ç¢º ---
        const propertyPlans = properties.map(p => {
            const safeP = {
                ...p,
                buyAge: Number(p.buyAge),
                price: Number(p.price),
                downPayment: Number(p.downPayment),
                loanTerm: Number(p.loanTerm),
                rate: Number(p.rate)
            };
            return {
                ...safeP,
                ...calculateLoan(safeP.price, safeP.downPayment, safeP.loanTerm, safeP.rate),
                remainingMonths: safeP.loanTerm * 12
            };
        });

        const carPlans = cars.map(c => {
            const safeC = {
                ...c,
                buyAge: Number(c.buyAge),
                price: Number(c.price),
                downPayment: Number(c.downPayment),
                loanTerm: Number(c.loanTerm),
                rate: Number(c.rate)
            };
            return {
                ...safeC,
                ...calculateLoan(safeC.price, safeC.downPayment, safeC.loanTerm, safeC.rate),
                remainingMonths: safeC.loanTerm * 12
            };
        });
        // --- ä¿®æ­£çµæŸ ---

        const dataPoints = []; 
        const labels = [];      
        let bankruptAge = null; 
        let totalEarned = 0;    
        let totalPassive = 0;   
        
        let expenseStats = { living:0, housing:0, car:0, children:0, parents:0, marriage:0, customTotal:0 };
        let customBreakdown = {};

        for (let i = params.currentAge; i <= params.lifeExpectancy; i++) {
            let yearIncome = 0;
            let yearDetails = { living:0, housing:0, car:0, children:0, parents:0, marriage:0, custom:0 };
            const deflator = Math.pow(1 + params.inflationRate/100, i - params.currentAge);

            if (i < params.retireAge) { 
                yearIncome += currentMonthlyWage * (12 + params.bonusMonths); 
                currentMonthlyWage *= (1 + params.incomeGrowth/100); 
            }
            
            passiveIncomes.forEach(pi => {
                if (i >= pi.startAge && i <= pi.endAge) {
                    let annual = 0;
                    if (pi.frequency === 'daily') annual = pi.amount * 365;
                    else if (pi.frequency === 'monthly') annual = pi.amount * 12;
                    else if (pi.frequency === 'quarterly') annual = pi.amount * 4;
                    else annual = pi.amount;
                    const nom = annual * deflator;
                    yearIncome += nom;
                    totalPassive += nom;
                }
            });

            if (params.enableLivingExpense) yearDetails.living += params.monthlyExpense * 10000 * 12 * deflator;
            if (params.hasParents && i >= params.parentsStartAge && i <= params.parentsEndAge) yearDetails.parents += params.parentsMonthlyCost * 10000 * 12 * deflator;

            propertyPlans.forEach(plan => {
                // é€™è£¡çš„ i å’Œ plan.buyAge å·²ç¶“éƒ½æ˜¯ Numberï¼Œæ¯”è¼ƒæœƒæ­£ç¢º
                if (i === plan.buyAge) {
                    const inflatedPrice = plan.price * 10000 * deflator; 
                    yearDetails.housing += inflatedPrice * (plan.downPayment/100); 
                    plan.actualMonthlyPayment = calculateLoan(plan.price * deflator, plan.downPayment, plan.loanTerm, plan.rate).monthly;
                }
                if (i >= plan.buyAge && plan.remainingMonths > 0) {
                    const monthsToPay = Math.min(12, plan.remainingMonths); 
                    yearDetails.housing += (plan.actualMonthlyPayment || 0) * monthsToPay; 
                    plan.remainingMonths -= monthsToPay;
                }
            });

            carPlans.forEach(plan => {
                if (i === plan.buyAge) {
                    const inflatedPrice = plan.price * 10000 * deflator;
                    yearDetails.car += inflatedPrice * (plan.downPayment/100);
                    plan.actualMonthlyPayment = calculateLoan(plan.price * deflator, plan.downPayment, plan.loanTerm, plan.rate).monthly;
                }
                if (i >= plan.buyAge && plan.remainingMonths > 0) {
                    const monthsToPay = Math.min(12, plan.remainingMonths);
                    yearDetails.car += (plan.actualMonthlyPayment || 0) * monthsToPay;
                    plan.remainingMonths -= monthsToPay;
                }
                if (i >= plan.buyAge && i < plan.buyAge + 15) yearDetails.car += (plan.price * 10000 * 0.1) * deflator;
            });

            childrenList.forEach(child => {
                const childAge = i - child.birthAge;
                if (childAge >= 0) { 
                    let currentStageStart = 0;
                    for (let stage of child.stages) {
                        const stageEnd = currentStageStart + stage.duration;
                        if (childAge >= currentStageStart && childAge < stageEnd) {
                            yearDetails.children += stage.cost * 10000 * 12 * deflator;
                            break;
                        }
                        currentStageStart += stage.duration;
                    }
                }
            });

            if (params.hasMarriage && i === params.marriageAge) yearDetails.marriage += params.marriageCost * 10000 * deflator;

            customExpenses.forEach(exp => {
                let isHappening = false;
                let annualAmount = 0;
                if (exp.frequency === 'once') {
                    if (i === exp.startAge) { annualAmount = exp.amount; isHappening = true; }
                } else {
                    const end = exp.endAge || 85;
                    if (i >= exp.startAge && i <= end) {
                        if (exp.frequency === 'weekly') annualAmount = exp.amount * 52;
                        else if (exp.frequency === 'monthly') annualAmount = exp.amount * 12;
                        else if (exp.frequency === 'yearly') annualAmount = exp.amount;
                        isHappening = true;
                    }
                }
                if (isHappening) {
                    const cost = annualAmount * 10000 * deflator; 
                    yearDetails.custom += cost;
                    const key = exp.name || 'æœªå‘½åé …ç›®';
                    if (!customBreakdown[key]) customBreakdown[key] = 0;
                    customBreakdown[key] += cost;
                }
            });

            const yearExpenseTotal = Object.values(yearDetails).reduce((a, b) => a + b, 0); 
            
            Object.keys(yearDetails).forEach(k => {
                if (k === 'custom') expenseStats.customTotal += yearDetails[k];
                else if (expenseStats[k] !== undefined) expenseStats[k] += yearDetails[k];
            });
            expenseStats.total = (expenseStats.total || 0) + yearExpenseTotal; 

            totalEarned += yearIncome;
            nominalAssets = nominalAssets + yearIncome - yearExpenseTotal;

            if (nominalAssets > 0) {
                nominalAssets *= (1 + params.investReturn/100);
            } else {
                nominalAssets *= 1.05; 
                if (!bankruptAge) bankruptAge = i; 
            }

            labels.push(`${i}æ­²`);
            dataPoints.push(Math.round((nominalAssets / deflator) / 10000));
        }
        
        return { labels, dataPoints, bankruptAge, totalEarned, totalPassive, expenseStats, customBreakdown, finalRealAssets: dataPoints[dataPoints.length-1] * 10000 };
    };

    const IMEInput = ({ value, onChange, className, placeholder, disabled, style }) => {
        const [localValue, setLocalValue] = useState(value);
        const isComposing = useRef(false); 
        useEffect(() => { if (!isComposing.current) setLocalValue(value); }, [value]);
        const handleChange = (e) => { 
            setLocalValue(e.target.value); 
            if (!isComposing.current) onChange(e); 
        };
        return <input type="text" value={localValue} onChange={handleChange} onCompositionStart={() => { isComposing.current = true; }} onCompositionEnd={(e) => { isComposing.current = false; onChange(e); }} className={className} placeholder={placeholder} disabled={disabled} style={style} />;
    };

    const CollapsibleSection = ({ title, isOpen, onToggle, children, icon, colorClass = "bg-white", headerClass="" }) => (
        <div className={`rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-4 transition-all duration-300 ${colorClass}`}>
            <button onClick={onToggle} className={`w-full flex items-center justify-between p-4 text-left font-bold text-slate-700 hover:bg-black/5 transition-colors ${headerClass}`}>
                <div className="flex items-center gap-2">{icon && <span className="text-lg">{icon}</span>}<span>{title}</span></div>
                <i className={`ph-bold ph-caret-down transition-transform duration-300 ${isOpen ? 'rotate-180' : ''}`}></i>
            </button>
            <div className={`transition-all duration-300 ease-in-out ${isOpen ? 'max-h-[3000px] opacity-100' : 'max-h-0 opacity-0'}`}>
                <div className="p-4 border-t border-black/5">{children}</div>
            </div>
        </div>
    );

    const AddItemBox = ({ title, children, onAdd, disabled, footer }) => (
        <div className="bg-slate-50 p-3 rounded mb-3 border border-slate-200">
            <div className="text-xs text-slate-500 mb-2 font-bold">{title}</div>
            {children}
            {footer && <div className="mt-2 pt-2 border-t border-slate-200 text-xs text-slate-500">{footer}</div>}
            <button onClick={onAdd} disabled={disabled} className="w-full py-2 bg-slate-600 text-white rounded text-sm hover:bg-slate-700 disabled:opacity-50 font-bold mt-2">æ–°å¢</button>
        </div>
    );

    const NumberControl = ({ label, value, onChange, min, max, step = 1, unit = '', subLabel = '', disabled = false, readOnly = false, compact = false }) => {
        const handleStep = (delta) => { if (disabled || readOnly) return; const nextVal = parseFloat(((Number(value) || 0) + delta).toFixed(2)); if (nextVal >= min && nextVal <= max) onChange(nextVal); };
        const handleChange = (e) => { if (disabled || readOnly) return; const inputVal = e.target.value; if (inputVal === '') { onChange(''); return; } const val = parseFloat(inputVal); if (!isNaN(val)) onChange(val); };
        const handleBlur = () => { if (value === '' || value < min) onChange(min); else if (value > max) onChange(max); };
        return (
            <div className={`transition-all ${disabled ? 'opacity-40 pointer-events-none' : 'opacity-100'} ${readOnly ? 'opacity-80' : ''} ${compact ? 'mb-2' : 'mb-4'}`}>
                {!compact && <div className="flex justify-between items-end mb-1"><label className="text-xs font-bold text-slate-500 uppercase tracking-wider">{label} <span className="text-slate-400 font-normal lowercase">{subLabel}</span></label><span className={`text-xs font-mono font-bold ${value < 0 ? 'text-red-500' : 'text-blue-600'}`}>{value} {unit}</span></div>}
                <div className="flex items-center gap-1">
                    {compact && <span className="text-xs text-slate-500 w-16 truncate mr-1" title={label}>{label}</span>}
                    {!readOnly && <button onClick={() => handleStep(-step)} className="w-6 h-8 flex items-center justify-center bg-white border border-slate-300 rounded hover:bg-slate-100 text-slate-600">-</button>}
                    <div className="flex-1"><input type="number" value={value} onChange={handleChange} onBlur={handleBlur} readOnly={readOnly} className={`w-full h-8 text-center border border-slate-300 rounded text-sm font-semibold bg-white ${value < 0 ? 'text-red-600' : 'text-slate-700'} ${readOnly ? 'bg-slate-100 text-slate-500 cursor-not-allowed' : ''}`}/></div>
                    {!readOnly && <button onClick={() => handleStep(step)} className="w-6 h-8 flex items-center justify-center bg-white border border-slate-300 rounded hover:bg-slate-100 text-slate-600">+</button>}
                </div>
                {!readOnly && !compact && <input type="range" min={min} max={max} step={step} value={Number(value) || min} onChange={(e) => !disabled && onChange(parseFloat(e.target.value))} className="w-full mt-2 h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-500 block"/>}
            </div>
        );
    };

    const AIAdvisorModal = ({ isOpen, onClose, data, simulationResult }) => {
        const [analysis, setAnalysis] = useState("");
        const [isLoading, setIsLoading] = useState(false);
        useEffect(() => { if (isOpen && !analysis) generateAdvice(); }, [isOpen]);
        const generateAdvice = async () => {
            setIsLoading(true);
            const prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å°ç£ç†è²¡é¡§å•ã€‚è«‹æ ¹æ“šä»¥ä¸‹ä½¿ç”¨è€…æ¨¡æ“¬æ•¸æ“šæä¾›å…·é«”ã€åœ¨åœ°åŒ–çš„è²¡å‹™å»ºè­°ã€‚è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œèªæ°£å°ˆæ¥­ä½†è¦ªåˆ‡ã€‚è«‹ä½¿ç”¨ Markdown æ ¼å¼ã€‚
                ã€ä½¿ç”¨è€…ç¾æ³ã€‘
                - å¹´é½¡: ${data.params.currentAge} æ­² (é æœŸå£½å‘½ ${data.params.lifeExpectancy})
                - æœˆè–ª: ${data.params.monthlyIncome} è¬
                - ç›®å‰è³‡ç”¢: ${data.params.currentAssets} è¬
                - é è¨ˆé€€ä¼‘: ${data.params.retireAge} æ­²
                - æŠ•è³‡å ±é…¬ç‡: ${data.params.investReturn}%
                - é€šè†¨ç‡: ${data.params.inflationRate}%
                - æˆ¿ç”¢æ•¸: ${data.properties.length} (ç¸½è² å‚µè©³è¦‹è²¸æ¬¾)
                ã€æ¨¡æ“¬çµæœã€‘
                - ç ´ç”¢é¢¨éšª: ${simulationResult.bankruptAge ? `åœ¨ ${simulationResult.bankruptAge} æ­²ç ´ç”¢` : 'ç„¡ç ´ç”¢é¢¨éšª'}
                - 85æ­²ç´¯ç©å¯¦è³ªè³‡ç”¢: ${Math.round(simulationResult.finalRealAssets/10000)} è¬
                - è¢«å‹•æ”¶å…¥ä½”ç¸½æ”¶å…¥æ¯”ä¾‹: ${simulationResult.totalEarned > 0 ? ((simulationResult.totalPassive / simulationResult.totalEarned)*100).toFixed(1) : 0}%
                è«‹æä¾› 3 é»é—œéµå»ºè­°ï¼Œé‡å°ä»¥ä¸‹é¢å‘ï¼š1. è³‡ç”¢é…ç½®èˆ‡æŠ•è³‡æ•ˆç‡ 2. é‡å¤§æ”¯å‡ºé¢¨éšª 3. é–‹æºç¯€æµçš„å…·é«”æ–¹å‘ (é‡å°å°ç£ç”Ÿæ´»ç’°å¢ƒ)`;
            const result = await callGeminiAPI(prompt);
            setAnalysis(result);
            setIsLoading(false);
        };
        if (!isOpen) return null;
        return (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col overflow-hidden">
                    <div className="bg-gradient-to-r from-blue-600 to-indigo-600 p-4 text-white flex justify-between items-center"><h2 className="font-bold text-lg flex items-center gap-2"><i className="ph-fill ph-sparkle"></i> AI è²¡å‹™é¡§å•è¨ºæ–·</h2><button onClick={onClose} className="hover:bg-white/20 rounded-full p-1"><i className="ph-bold ph-x"></i></button></div>
                    <div className="p-6 overflow-y-auto custom-scrollbar flex-1 relative">
                        {isLoading ? <div className="flex flex-col items-center justify-center h-48 space-y-4"><div className="w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin"></div><div className="text-slate-500 text-sm animate-pulse">æ­£åœ¨åˆ†ææ‚¨çš„è²¡å‹™æ•¸æ“š...</div></div> : <div className="prose prose-slate text-sm w-full max-w-none" dangerouslySetInnerHTML={{ __html: marked.parse(analysis) }}></div>}
                    </div>
                    <div className="p-4 border-t bg-slate-50 flex justify-end"><button onClick={generateAdvice} className="mr-2 px-4 py-2 text-slate-600 hover:bg-slate-200 rounded text-sm font-bold">é‡æ–°åˆ†æ</button><button onClick={onClose} className="px-6 py-2 bg-blue-600 text-white rounded shadow hover:bg-blue-700 text-sm font-bold">äº†è§£</button></div>
                </div>
            </div>
        );
    };

    const AIBudgetOptimizer = ({ dailyItems, onOptimize }) => {
        const [suggestion, setSuggestion] = useState(null);
        const [loading, setLoading] = useState(false);
        const handleOptimize = async () => {
            if (dailyItems.length === 0) return;
            setLoading(true);
            const itemsStr = dailyItems.map(i => `${i.name}: ${i.cost}å…ƒ`).join(', ');
            const prompt = `ä½ æ˜¯ä¸€ä½ç²¾æ‰“ç´°ç®—çš„å°ç£ç”Ÿæ´»ç®¡å®¶ã€‚è«‹æª¢è¦–ä½¿ç”¨è€…çš„æ¯æ—¥é–‹éŠ·æ¸…å–®ï¼š[${itemsStr}]ã€‚è«‹æ‰¾å‡º 1-2 å€‹å¯ä»¥ã€Œç„¡ç—›çœéŒ¢ã€çš„å…·é«”å»ºè­°ã€‚ä¸éœ€è¦é•·ç¯‡å¤§è«–ï¼Œè«‹ç›´æ¥çµ¦å‡ºç°¡çŸ­å»ºè­° (50å­—ä»¥å…§)ã€‚`;
            const result = await callGeminiAPI(prompt);
            setSuggestion(result);
            setLoading(false);
        };
        return (
            <div className="mt-3 border-t border-dashed border-slate-300 pt-3">
                {!suggestion && !loading && <button onClick={handleOptimize} className="w-full py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded text-xs font-bold shadow hover:opacity-90 flex items-center justify-center gap-1 ai-pulse"><i className="ph-fill ph-magic-wand"></i> âœ¨ AI å¹«æˆ‘çœéŒ¢</button>}
                {loading && <div className="text-xs text-center text-slate-400 py-2">æ€è€ƒä¸­...</div>}
                {suggestion && <div className="bg-purple-50 p-3 rounded text-xs border border-purple-100"><div className="font-bold text-purple-700 mb-1 flex items-center gap-1"><i className="ph-fill ph-lightbulb"></i> çœéŒ¢é»å­ï¼š</div><div className="text-slate-700">{suggestion}</div><button onClick={() => setSuggestion(null)} className="text-[10px] text-slate-400 underline mt-2">é—œé–‰</button></div>}
            </div>
        );
    };

    const ExpensePieChart = ({ data, customBreakdown }) => {
        const chartRef = useRef(null); 
        const chartInstanceRef = useRef(null); 
        useEffect(() => {
            const ctx = chartRef.current.getContext('2d');
            if (chartInstanceRef.current) chartInstanceRef.current.destroy(); 
            
            let labels = ['ç”Ÿæ´»è²»', 'æˆ¿ç”¢æ”¯å‡º', 'å­å¥³é¤Šè‚²', 'è»Šè¼›äº¤é€š', 'å¥‰é¤Šçˆ¶æ¯', 'å©šå§»'];
            let values = [data.living, data.housing, data.children, data.car, data.parents, data.marriage];
            let colors = ['#94a3b8', '#8b5cf6', '#f97316', '#0ea5e9', '#14b8a6', '#ec4899'];

            if (customBreakdown && Object.keys(customBreakdown).length > 0) {
                const customKeys = Object.keys(customBreakdown);
                labels = [...labels, ...customKeys];
                values = [...values, ...customKeys.map(k => customBreakdown[k])];
                const customColors = customKeys.map((_, i) => `hsl(${140 + i * 20}, 70%, ${40 + (i % 3) * 10}%)`);
                colors = [...colors, ...customColors];
            } else if (data.customTotal > 0) {
                labels.push('è‡ªè¨‚æ”¯å‡º');
                values.push(data.customTotal);
                colors.push('#10b981');
            }

            chartInstanceRef.current = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        borderWidth: 0, hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { boxWidth: 12, font: { size: 10 } } }, tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${Math.round(ctx.raw/10000)}è¬` } } }
                }
            });
            return () => { if (chartInstanceRef.current) chartInstanceRef.current.destroy(); };
        }, [data, customBreakdown]);
        return <canvas ref={chartRef} />;
    };

    const FinanceChart = ({ mainSimulation, comparisonSimulations }) => {
        const chartRef = useRef(null);
        const chartInstanceRef = useRef(null);
        useEffect(() => {
            const ctx = chartRef.current.getContext('2d');
            if (chartInstanceRef.current) chartInstanceRef.current.destroy();
            const datasets = [
                {
                    label: 'ç›®å‰è¨­å®š', data: mainSimulation.dataPoints,
                    borderColor: '#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    borderWidth: 3, pointRadius: 0, pointHoverRadius: 6, fill: true, tension: 0.3
                },
                ...comparisonSimulations.map((sim, idx) => ({
                    label: sim.name, data: sim.result.dataPoints,
                    borderColor: ['#64748b', '#ef4444', '#10b981', '#f59e0b'][idx % 4],
                    borderWidth: 2, borderDash: [5, 5], pointRadius: 0, fill: false, tension: 0.3
                }))
            ];
            chartInstanceRef.current = new Chart(ctx, {
                type: 'line', data: { labels: mainSimulation.labels, datasets: datasets },
                options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { display: true, position: 'top' } }, scales: { x: { grid: { display: false }, ticks: { maxTicksLimit: 8 } }, y: { grid: { borderDash: [4, 4], color: '#e2e8f0' } } } }
            });
            return () => { if (chartInstanceRef.current) chartInstanceRef.current.destroy(); };
        }, [mainSimulation, comparisonSimulations]);
        return <canvas ref={chartRef} />;
    };

    const App = () => {
        const [isSidebarOpen, setIsSidebarOpen] = useState(true);
        const [openSections, setOpenSections] = useState({ file: true, basic: true, income: true, expense: true, house: true, passive: false, parents: true, marriage: false, child: true, car: true, custom: false });
        const toggleSection = (key) => setOpenSections(prev => ({ ...prev, [key]: !prev[key] }));
        const [isAIModalOpen, setIsAIModalOpen] = useState(false);
        const [savedScenarios, setSavedScenarios] = useState([]);
        const [saveName, setSaveName] = useState('');
        const [compareTargets, setCompareTargets] = useState([]);
        const fileInputRef = useRef(null);

        useEffect(() => { const saves = localStorage.getItem('life_sim_saves'); if (saves) setSavedScenarios(JSON.parse(saves)); }, []);
        const handleSave = () => {
            if (!saveName.trim()) return;
            const currentData = { params, dailyItems, properties, cars, childrenList, passiveIncomes, customExpenses, useDailyDetail };
            const newSave = { id: Date.now(), name: saveName, date: new Date().toLocaleString(), data: currentData };
            const newSaves = [...savedScenarios, newSave];
            setSavedScenarios(newSaves);
            localStorage.setItem('life_sim_saves', JSON.stringify(newSaves));
            setSaveName('');
        };
        const handleLoad = (saveId) => {
            const target = savedScenarios.find(s => s.id === parseInt(saveId));
            if (target) {
                const d = target.data;
                setParams(d.params); setDailyItems(d.dailyItems); setProperties(d.properties); setCars(d.cars);
                setChildrenList(d.childrenList); setPassiveIncomes(d.passiveIncomes); setCustomExpenses(d.customExpenses);
                setUseDailyDetail(d.useDailyDetail);
            }
        };
        const handleDelete = (saveId) => {
            const newSaves = savedScenarios.filter(s => s.id !== saveId);
            setSavedScenarios(newSaves);
            localStorage.setItem('life_sim_saves', JSON.stringify(newSaves));
            setCompareTargets(compareTargets.filter(id => id !== saveId));
        };
        const toggleCompare = (saveId) => { if (compareTargets.includes(saveId)) setCompareTargets(compareTargets.filter(id => id !== saveId)); else setCompareTargets([...compareTargets, saveId]); };
        const handleExportFile = () => {
            const dataStr = JSON.stringify(savedScenarios, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `taiwan_life_sim_backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
        const handleImportFile = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    if (Array.isArray(json)) {
                        setSavedScenarios(json);
                        localStorage.setItem('life_sim_saves', JSON.stringify(json));
                        alert('åŒ¯å…¥æˆåŠŸï¼å·²é‚„åŸæ‰€æœ‰å­˜æª”ã€‚');
                    } else { alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼šå¿…é ˆæ˜¯å­˜æª”é™£åˆ—ã€‚'); }
                } catch (err) { alert('ç„¡æ³•è®€å–æª”æ¡ˆï¼Œè«‹ç¢ºèªæ ¼å¼ã€‚'); }
            };
            reader.readAsText(file);
            event.target.value = ''; 
        };

        const [params, setParams] = useState({
            currentAge: 25, lifeExpectancy: 85, retireAge: 65, currentAssets: 50, 
            monthlyIncome: 4.5, bonusMonths: 1.5, incomeGrowth: 2.0,
            enableLivingExpense: true, monthlyExpense: 2.0, inflationRate: 2.0, investReturn: 5.0, 
            hasMarriage: true, marriageAge: 32, marriageCost: 80, 
            hasParents: true, parentsStartAge: 25, parentsEndAge: 60, parentsMonthlyCost: 1.0,
            emergencyFundMonths: 6 // æ–°å¢é å‚™é‡‘æœˆæ•¸é è¨­å€¼
        });

        const [useDailyDetail, setUseDailyDetail] = useState(false);
        const [dailyItems, setDailyItems] = useState([
            { id: 1, name: 'æ—©é¤', cost: 50 }, { id: 2, name: 'åˆé¤', cost: 120 }, { id: 3, name: 'æ™šé¤', cost: 150 },
            { id: 4, name: 'äº¤é€š', cost: 60 }, { id: 5, name: 'é£²æ–™/é»å¿ƒ', cost: 50 }
        ]);
        const dailyTotal = dailyItems.reduce((acc, i) => acc + (parseInt(i.cost)||0), 0);
        useEffect(() => { if (useDailyDetail) setParams(prev => ({ ...prev, monthlyExpense: parseFloat(((dailyTotal * 30)/10000).toFixed(2)) })); }, [useDailyDetail, dailyTotal]);

        const [properties, setProperties] = useState([{ id: 1, name: 'è‡ªä½æˆ¿', buyAge: 36, price: 1600, downPayment: 20, loanTerm: 30, rate: 2.2 }]);
        const [newProperty, setNewProperty] = useState({ name: '', buyAge: 36, price: '', downPayment: 20, loanTerm: 30, rate: 2.2 });
        
        // å»ºè­°è³¼å±‹é ç®—èˆ‡é©åˆè³¼å±‹å¹´é½¡è¨ˆç®—
        const suggestedHousePrice = useMemo(() => {
            const maxAffordableMonthlyPayment = params.monthlyIncome * 10000 * 0.33;
            const r = (newProperty.rate / 100) / 12;
            const n = newProperty.loanTerm * 12;
            let maxLoan = r > 0 ? maxAffordableMonthlyPayment * (Math.pow(1 + r, n) - 1) / (r * Math.pow(1 + r, n)) : maxAffordableMonthlyPayment * n;
            return Math.round((maxLoan / (1 - newProperty.downPayment / 100)) / 10000);
        }, [params.monthlyIncome, newProperty.rate, newProperty.loanTerm, newProperty.downPayment]);

        const suitableBuyAge = useMemo(() => {
            let assets = params.currentAssets * 10000;
            // ä¿®æ­£ï¼šç¾åœ¨ä½¿ç”¨ä½¿ç”¨è€…ç•¶å‰è¼¸å…¥çš„åƒ¹æ ¼ (newProperty.price) ä¾†è¨ˆç®—
            // å¦‚æœè¼¸å…¥æ¡†æ˜¯ç©ºçš„ï¼Œå°±ç”¨ 0 (é¿å… NaN)
            const targetPrice = parseFloat(newProperty.price) || 0;
            const downPayment = targetPrice * 10000 * (newProperty.downPayment / 100);
            
            // ç°¡æ˜“ä¼°ç®—æ¯å¹´çš„å„²è“„ (å¹´æ”¶å…¥ - å¹´æ”¯å‡º)
            const annualIncome = params.monthlyIncome * 10000 * (12 + params.bonusMonths);
            const annualExpense = params.monthlyExpense * 10000 * 12;
            const annualSave = annualIncome - annualExpense;

            if (annualSave <= 0 && assets < downPayment) return null; // å­˜ä¸åˆ°éŒ¢ä¸”ç›®å‰è³‡ç”¢ä¸è¶³

            let age = params.currentAge;
            // æ¨¡æ“¬ç›´åˆ°å­˜åˆ°é ­æœŸæ¬¾
            while (age < 80) {
                 if (assets >= downPayment) return age;
                 assets += annualSave;
                 assets *= (1 + params.investReturn/100); // ç°¡å–®è¤‡åˆ©
                 age++;
            }
            return null;
        }, [params, newProperty.price, newProperty.downPayment]); // ä¾è³´é …æ”¹ç‚º newProperty.price

        // åˆå§‹åŒ– newProperty çš„ price ç‚ºå»ºè­°æˆ¿åƒ¹ (åƒ…åœ¨ component mount æ™‚åŸ·è¡Œä¸€æ¬¡)
        useEffect(() => {
             setNewProperty(prev => ({ ...prev, price: suggestedHousePrice }));
        }, []); // Empty dependency array, run once on mount

        const addProperty = () => { 
            if (!newProperty.name || !newProperty.price) return; 
            // ä¿®æ­£ï¼šå…è¨±å°æ•¸é»è¼¸å…¥ï¼Œå¾ parseInt æ”¹ç‚º parseFloat
            setProperties([...properties, { ...newProperty, id: Date.now(), price: parseFloat(newProperty.price) }]); 
            setNewProperty({ name: '', buyAge: suitableBuyAge || 36, price: suggestedHousePrice, downPayment: 20, loanTerm: 30, rate: 2.2 }); 
        };
        const removeProperty = (id) => setProperties(properties.filter(p => p.id !== id));

        const [cars, setCars] = useState([{ id: 1, name: 'ç¬¬ä¸€å°è»Š', buyAge: 30, price: 90, downPayment: 30, loanTerm: 5, rate: 3.5 }]);
        const [newCar, setNewCar] = useState({ name: '', buyAge: 30, price: '', downPayment: 30, loanTerm: 5, rate: 3.5 });
        const addCar = () => { 
            if (!newCar.name || !newCar.price) return; 
            // ä¿®æ­£ï¼šå…è¨±å°æ•¸é»è¼¸å…¥ï¼Œå¾ parseInt æ”¹ç‚º parseFloat
            setCars([...cars, { ...newCar, id: Date.now(), price: parseFloat(newCar.price) }]); 
            setNewCar({ name: '', buyAge: 30, price: '', downPayment: 30, loanTerm: 5, rate: 3.5 }); 
        };
        const removeCar = (id) => setCars(cars.filter(c => c.id !== id));
        const updateCar = (id, field, value) => setCars(cars.map(c => c.id === id ? { ...c, [field]: value } : c));

        const DEFAULT_CHILD_STAGES = [
            { id: 1, name: 'å¬°å…’æœŸ', duration: 3, cost: 3.5 }, { id: 2, name: 'å¹¼å…’åœ’', duration: 3, cost: 2.5 },
            { id: 3, name: 'å°å­¸', duration: 6, cost: 1.5 }, { id: 4, name: 'åœ‹é«˜ä¸­', duration: 6, cost: 2.0 }, { id: 5, name: 'å¤§å­¸', duration: 4, cost: 2.5 }
        ];
        const [childrenList, setChildrenList] = useState([{ id: 1, name: 'ç¬¬ä¸€èƒ', birthAge: 34, stages: JSON.parse(JSON.stringify(DEFAULT_CHILD_STAGES)) }]);
        const [newChild, setNewChild] = useState({ name: '', birthAge: 34 });
        const addChild = () => { setChildrenList([...childrenList, { id: Date.now(), name: newChild.name || `ç¬¬${childrenList.length+1}èƒ`, birthAge: newChild.birthAge, stages: JSON.parse(JSON.stringify(DEFAULT_CHILD_STAGES)) }]); setNewChild({ name: '', birthAge: newChild.birthAge + 2 }); };
        const removeChild = (id) => setChildrenList(childrenList.filter(c => c.id !== id));
        const updateChildStage = (cId, sId, field, val) => setChildrenList(childrenList.map(c => c.id === cId ? { ...c, stages: c.stages.map(s => s.id === sId ? { ...s, [field]: val } : s) } : c));

        const [passiveIncomes, setPassiveIncomes] = useState([]);
        const [newPassive, setNewPassive] = useState({ name: '', amount: '', frequency: 'monthly', startAge: '', endAge: '' });
        const addPassiveIncome = () => { 
            if (!newPassive.name || !newPassive.amount) return; 
            // ä¿®æ­£ï¼šå…è¨±å°æ•¸é»è¼¸å…¥ï¼Œå¾ parseInt æ”¹ç‚º parseFloat
            setPassiveIncomes([...passiveIncomes, { ...newPassive, amount: parseFloat(newPassive.amount), startAge: parseInt(newPassive.startAge), endAge: parseInt(newPassive.endAge || 85), id: Date.now() }]); 
            setNewPassive({ name: '', amount: '', frequency: 'monthly', startAge: '', endAge: '' }); 
        };
        const removePassiveIncome = (id) => setPassiveIncomes(passiveIncomes.filter(p => p.id !== id));

        const [customExpenses, setCustomExpenses] = useState([]);
        const [newCustomExp, setNewCustomExp] = useState({ name: '', amount: '', frequency: 'once', startAge: '', endAge: '' }); 
        const addCustomExpense = () => { 
            if (!newCustomExp.name || !newCustomExp.amount) return; 
            // ä¿®æ­£ï¼šå…è¨±å°æ•¸é»è¼¸å…¥ï¼Œå¾ parseInt æ”¹ç‚º parseFloat
            setCustomExpenses([...customExpenses, { ...newCustomExp, startAge: parseInt(newCustomExp.startAge), endAge: parseInt(newCustomExp.frequency === 'once' ? newCustomExp.startAge : newCustomExp.endAge), amount: parseFloat(newCustomExp.amount), id: Date.now() }]); 
            setNewCustomExp({ name: '', amount: '', frequency: 'once', startAge: '', endAge: '' }); 
        };
        const removeCustomExpense = (id) => setCustomExpenses(customExpenses.filter(e => e.id !== id));
        const updateCustomExpense = (id, field, value) => {
            setCustomExpenses(customExpenses.map(item => item.id === id ? { ...item, [field]: value } : item));
        };

        const simulation = useMemo(() => coreSimulation({ params, properties, cars, childrenList, passiveIncomes, customExpenses }), [params, properties, cars, childrenList, passiveIncomes, customExpenses]);
        const comparisonSimulations = useMemo(() => compareTargets.map(id => { const save = savedScenarios.find(s => s.id === id); if (!save) return null; return { name: save.name, result: coreSimulation(save.data) }; }).filter(Boolean), [compareTargets, savedScenarios]);
        
        const safeRetireAge = useMemo(() => {
            for (let age = params.currentAge; age <= params.lifeExpectancy; age++) {
                const tempParams = { ...params, retireAge: age };
                const res = coreSimulation({ params: tempParams, properties, cars, childrenList, passiveIncomes, customExpenses });
                if (res.finalRealAssets >= 0 && (!res.bankruptAge || res.bankruptAge > params.lifeExpectancy)) return age;
            }
            return null;
        }, [params, properties, cars, childrenList, passiveIncomes, customExpenses]);

        const dailyStats = useMemo(() => {
            const annualSalary = params.monthlyIncome * 10000 * (12 + params.bonusMonths);
            let annualPassive = 0;
            passiveIncomes.forEach(pi => {
                let annual = 0;
                if (pi.frequency === 'daily') annual = pi.amount * 365;
                else if (pi.frequency === 'monthly') annual = pi.amount * 12;
                else if (pi.frequency === 'quarterly') annual = pi.amount * 4;
                else annual = pi.amount;
                annualPassive += annual;
            });
            const annualLiving = params.enableLivingExpense ? params.monthlyExpense * 10000 * 12 : 0;
            const annualParents = params.hasParents ? params.parentsMonthlyCost * 10000 * 12 : 0;
            let annualHousing = 0; 
            properties.forEach(p => { 
                const { monthly } = calculateLoan(p.price, p.downPayment, p.loanTerm, p.rate);
                annualHousing += monthly * 12; 
            });
            let annualCar = 0; 
            cars.forEach(c => { 
                const { monthly } = calculateLoan(c.price, c.downPayment, c.loanTerm, c.rate);
                annualCar += monthly * 12; 
            });
            let annualChild = 0; 
            childrenList.forEach(child => { 
                const age = params.currentAge - child.birthAge; 
                if (age>=0) { 
                    let sStart=0; 
                    for(let s of child.stages) { 
                        if(age>=sStart && age<sStart+s.duration) { 
                            annualChild += s.cost * 10000 * 12; 
                            break; 
                        } 
                        sStart+=s.duration; 
                    } 
                } 
            });

            // --- æ–°å¢ï¼šè™•ç†è‡ªè¨‚æ”¯å‡ºçš„ç´°é … ---
            let annualCustomTotal = 0;
            const customBreakdownItems = [];
            customExpenses.forEach(exp => {
                let annual = 0;
                const end = exp.endAge || 85;
                // æª¢æŸ¥ç›®å‰å¹´é½¡æ˜¯å¦åœ¨æ”¯å‡ºå€é–“å…§
                if (params.currentAge >= exp.startAge && params.currentAge <= end) {
                    if (exp.frequency === 'weekly') annual = exp.amount * 10000 * 52;
                    else if (exp.frequency === 'monthly') annual = exp.amount * 10000 * 12;
                    else if (exp.frequency === 'yearly') annual = exp.amount * 10000;
                    else if (exp.frequency === 'once' && params.currentAge === exp.startAge) annual = exp.amount * 10000;
                }
                
                if (annual > 0) {
                    annualCustomTotal += annual;
                    customBreakdownItems.push({ label: exp.name || 'è‡ªè¨‚æ”¯å‡º', type: 'exp', val: annual });
                }
            });
            // -------------------------------

            const totalIncomeAnnual = annualSalary + annualPassive;
            const totalExpenseAnnual = annualLiving + annualHousing + annualParents + annualCar + annualChild + annualCustomTotal;

            const breakdown = [
                { label: 'å·¥ä½œå¹´è–ª', type: 'inc', val: annualSalary },
                { label: 'è¢«å‹•æ”¶å…¥', type: 'inc', val: annualPassive },
                { label: 'åŸºæœ¬ç”Ÿæ´»', type: 'exp', val: annualLiving },
                { label: 'æˆ¿ç”¢æ”¯å‡º', type: 'exp', val: annualHousing },
                { label: 'å­å¥³é¤Šè‚²', type: 'exp', val: annualChild },
                { label: 'è»Šè¼›äº¤é€š', type: 'exp', val: annualCar },
                { label: 'å­è¦ªè²»', type: 'exp', val: annualParents },
                ...customBreakdownItems // å°‡è‡ªè¨‚ç´°é …å±•é–‹åŠ å…¥åˆ—è¡¨
            ].filter(i => i.val > 0).map(i => ({
                ...i,
                daily: Math.round(i.val / 365),
                monthly: Math.round(i.val / 12),
                yearly: Math.round(i.val)
            }));
            return {
                income: Math.round(totalIncomeAnnual / 365),
                expense: Math.round(totalExpenseAnnual / 365),
                breakdown: breakdown,
                details: { 
                    totalIncome: { daily: Math.round(totalIncomeAnnual/365), monthly: Math.round(totalIncomeAnnual/12), yearly: Math.round(totalIncomeAnnual) },
                    totalExpense: { daily: Math.round(totalExpenseAnnual/365), monthly: Math.round(totalExpenseAnnual/12), yearly: Math.round(totalExpenseAnnual) }
                }
            };
        }, [params, properties, cars, childrenList, passiveIncomes, customExpenses]);

        const [showDetailTable, setShowDetailTable] = useState(false);

        return (
            <div className="flex flex-col min-h-screen bg-slate-100">
                <header className="bg-white border-b px-4 py-3 sticky top-0 z-30 shadow-sm flex justify-between items-center">
                    <div className="flex items-center gap-3">
                        <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="p-2 bg-slate-100 rounded hover:bg-slate-200 text-slate-600"><i className={`ph-bold ${isSidebarOpen ? 'ph-caret-left' : 'ph-list'}`}></i></button>
                        <h1 className="font-bold text-lg text-slate-800 flex items-center gap-2"><i className="ph-fill ph-trend-up text-blue-600"></i><span className="hidden sm:inline">äººç”Ÿè²¡å‹™æ¨¡æ“¬ v7.4.1</span></h1>
                    </div>
                    <div className="flex items-center gap-4">
                        <button onClick={() => setIsAIModalOpen(true)} className="hidden md:flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-indigo-500 to-blue-500 text-white rounded-full font-bold shadow-md hover:scale-105 transition-transform ai-pulse"><i className="ph-fill ph-sparkle"></i> AI è²¡å‹™é¡§å•è¨ºæ–·</button>
                        <div className="text-right flex flex-col items-end"><span className="text-[10px] text-slate-400 uppercase font-bold">85æ­² å¯¦è³ªè³‡ç”¢</span><span className={`text-xl font-black ${simulation.finalRealAssets >= 0 ? 'text-blue-600' : 'text-red-500'}`}>{new Intl.NumberFormat().format(Math.round(simulation.finalRealAssets/10000))} è¬</span></div>
                    </div>
                </header>

                <AIAdvisorModal isOpen={isAIModalOpen} onClose={() => setIsAIModalOpen(false)} data={{ params, properties, cars, childrenList, passiveIncomes, customExpenses }} simulationResult={simulation} />

                <div className="flex flex-col lg:flex-row flex-1 relative">
                    <div className={`transition-all duration-300 ease-in-out bg-white border-r z-20 ${isSidebarOpen ? 'w-full lg:w-[480px] opacity-100' : 'w-0 lg:w-0 opacity-0 overflow-hidden'} flex flex-col lg:h-[calc(100vh-64px)] lg:sticky lg:top-[64px]`}>
                        <div className="flex-1 overflow-y-auto p-4 custom-scrollbar">
                            <CollapsibleSection title="æª”æ¡ˆç®¡ç† (å­˜æª”/åŒ¯å‡º/åŒ¯å…¥)" icon="ğŸ’¾" isOpen={openSections.file} onToggle={() => toggleSection('file')} colorClass="bg-slate-100" headerClass="text-slate-800">
                                <div className="space-y-3">
                                    <div className="flex gap-2"><IMEInput placeholder="è¼¸å…¥å­˜æª”åç¨±" value={saveName} onChange={e => setSaveName(e.target.value)} className="w-full px-2 py-2 border rounded text-sm"/><button onClick={handleSave} disabled={!saveName} className="px-4 py-2 bg-blue-600 text-white rounded text-sm font-bold disabled:opacity-50 whitespace-nowrap">å„²å­˜</button></div>
                                    <div className="flex gap-2"><button onClick={handleExportFile} className="flex-1 py-2 bg-white border border-slate-300 rounded text-sm text-slate-700 hover:bg-slate-50 flex items-center justify-center gap-1"><i className="ph-bold ph-download-simple"></i> ä¸‹è¼‰å‚™ä»½</button><button onClick={() => fileInputRef.current.click()} className="flex-1 py-2 bg-white border border-slate-300 rounded text-sm text-slate-700 hover:bg-slate-50 flex items-center justify-center gap-1"><i className="ph-bold ph-upload-simple"></i> åŒ¯å…¥æª”æ¡ˆ</button><input type="file" accept=".json" ref={fileInputRef} onChange={handleImportFile} className="hidden" /></div>
                                    {savedScenarios.length > 0 && (<div className="border-t border-slate-200 pt-2 space-y-2">{savedScenarios.map(save => (<div key={save.id} className="flex justify-between items-center bg-white p-2 rounded border border-slate-200 text-sm"><div className="flex items-center gap-2"><input type="checkbox" checked={compareTargets.includes(save.id)} onChange={() => toggleCompare(save.id)} className="w-4 h-4 accent-indigo-500" title="å‹¾é¸åŠ å…¥åœ–è¡¨æ¯”è¼ƒ"/><div onClick={() => handleLoad(save.id)} className="cursor-pointer hover:text-blue-600"><div className="font-bold">{save.name}</div><div className="text-[10px] text-slate-400">{save.date}</div></div></div><div className="flex gap-1"><button onClick={() => handleLoad(save.id)} className="px-2 py-1 bg-slate-100 text-slate-600 rounded hover:bg-blue-50 hover:text-blue-600 text-xs">è®€å–</button><button onClick={() => handleDelete(save.id)} className="px-2 py-1 bg-slate-100 text-slate-600 rounded hover:bg-red-50 hover:text-red-600 text-xs">åˆªé™¤</button></div></div>))}</div>)}
                                </div>
                            </CollapsibleSection>

                            <div className={`mb-4 rounded-xl p-4 text-white shadow-lg ${safeRetireAge && safeRetireAge <= 65 ? 'bg-gradient-to-br from-emerald-500 to-teal-600' : 'bg-gradient-to-br from-slate-700 to-slate-800'}`}>
                                <h3 className="text-xs font-bold opacity-80 mb-1 uppercase tracking-wider"><i className="ph-fill ph-medal"></i> è²¡å‹™è‡ªç”±é æ¸¬</h3>
                                <div className="flex justify-between items-end"><div><div className="text-2xl font-bold">{safeRetireAge ? `${safeRetireAge} æ­²` : 'ç„¡æ³•é€€ä¼‘'}</div><div className="text-xs opacity-75">{safeRetireAge ? 'å¯é”æˆè³‡ç”¢ä¸æ­¸é›¶' : 'è³‡ç”¢çµ‚å°‡è€—ç›¡'}</div></div><div className="text-right"><div className="text-xs opacity-75">ç›®å‰è¨­å®š</div><div className="font-bold">{params.retireAge} æ­²é€€</div></div></div>
                                {(safeRetireAge > 65 || !safeRetireAge) && <div className="mt-3 pt-2 border-t border-white/20 text-xs font-bold text-yellow-300 flex gap-2 items-center animate-pulse"><i className="ph-fill ph-warning"></i>è¶…æ”¯äº†ï¼Œå»ºè­°æ‰¾æœ€å¤§çš„æ”¯å‡ºå»æ”¹å–„</div>}
                            </div>
                            
                            <div className="mb-6 bg-white border border-slate-200 rounded-xl p-4 shadow-sm overflow-hidden transition-all duration-300">
                                <h3 className="text-xs font-bold text-slate-400 mb-3 uppercase tracking-wider flex items-center justify-between">
                                    <span className="flex items-center gap-2"><i className="ph-fill ph-calendar-check"></i> ç›®å‰æ”¶æ”¯æ¦‚æ³</span>
                                    <button onClick={() => setShowDetailTable(!showDetailTable)} className="text-blue-600 hover:bg-blue-50 px-2 py-1 rounded text-[10px] flex items-center gap-1">
                                        {showDetailTable ? 'éš±è—æ˜ç´°' : 'å±•é–‹æ˜ç´°'} <i className={`ph-bold ph-caret-down transition-transform ${showDetailTable ? 'rotate-180' : ''}`}></i>
                                    </button>
                                </h3>
                                
                                {!showDetailTable ? (
                                    <>
                                        <div className="grid grid-cols-2 gap-4 mb-4">
                                            <div><div className="text-xs text-slate-400">æ—¥æ”¶å…¥</div><div className="text-xl font-bold text-green-600 flex items-baseline gap-1">{new Intl.NumberFormat().format(dailyStats.income)}</div></div>
                                            <div><div className="text-xs text-slate-400">æ—¥æ”¯å‡º</div><div className="text-xl font-bold text-red-600 flex items-baseline gap-1">{new Intl.NumberFormat().format(dailyStats.expense)}</div></div>
                                        </div>
                                        <div className="mt-3 pt-2 border-t border-slate-100 flex justify-between items-center"><span className="text-xs font-bold text-slate-400">æ·¨ç¾é‡‘æµ</span><span className={`text-lg font-bold ${dailyStats.income - dailyStats.expense >= 0 ? 'text-blue-600' : 'text-red-500'}`}>{dailyStats.income - dailyStats.expense > 0 ? '+' : ''}{new Intl.NumberFormat().format(dailyStats.income - dailyStats.expense)}</span></div>
                                    </>
                                ) : (
                                    <div className="animate-fade-in">
                                        <table className="w-full text-xs text-right">
                                            <thead>
                                                <tr className="border-b border-slate-200 text-slate-400">
                                                    <th className="pb-2 text-left font-normal">é …ç›®</th>
                                                    <th className="pb-2 font-normal">æ—¥</th>
                                                    <th className="pb-2 font-normal">æœˆ</th>
                                                    <th className="pb-2 font-normal">å¹´ (è¬)</th>
                                                </tr>
                                            </thead>
                                            <tbody className="text-slate-600">
                                                {dailyStats.breakdown.map((item, idx) => (
                                                    <tr key={idx} className="border-b border-slate-50 hover:bg-slate-50">
                                                        <td className={`py-2 text-left font-bold ${item.type === 'inc' ? 'text-green-600' : 'text-slate-600'}`}>{item.label}</td>
                                                        <td className="py-2">{new Intl.NumberFormat().format(item.daily)}</td>
                                                        <td className="py-2">{new Intl.NumberFormat().format(item.monthly)}</td>
                                                        <td className="py-2">{Math.round(item.yearly/10000 * 10) / 10}</td>
                                                    </tr>
                                                ))}
                                                <tr className="border-t-2 border-slate-100 font-bold bg-slate-50/50">
                                                    <td className="py-2 text-left text-green-600">ç¸½æ”¶å…¥</td>
                                                    <td className="py-2 text-green-600">{new Intl.NumberFormat().format(dailyStats.details.totalIncome.daily)}</td>
                                                    <td className="py-2 text-green-600">{new Intl.NumberFormat().format(dailyStats.details.totalIncome.monthly)}</td>
                                                    <td className="py-2 text-green-600">{Math.round(dailyStats.details.totalIncome.yearly/10000)}</td>
                                                </tr>
                                                <tr className="font-bold bg-slate-50/50">
                                                    <td className="py-2 text-left text-red-500">ç¸½æ”¯å‡º</td>
                                                    <td className="py-2 text-red-500">{new Intl.NumberFormat().format(dailyStats.details.totalExpense.daily)}</td>
                                                    <td className="py-2 text-red-500">{new Intl.NumberFormat().format(dailyStats.details.totalExpense.monthly)}</td>
                                                    <td className="py-2 text-red-500">{Math.round(dailyStats.details.totalExpense.yearly/10000)}</td>
                                                </tr>
                                                <tr className="border-t border-slate-200 font-black">
                                                    <td className="py-3 text-left">æ·¨çµé¤˜</td>
                                                    <td className={`py-3 ${dailyStats.income - dailyStats.expense >= 0 ? 'text-blue-600' : 'text-red-600'}`}>{new Intl.NumberFormat().format(dailyStats.income - dailyStats.expense)}</td>
                                                    <td className={`py-3 ${dailyStats.income - dailyStats.expense >= 0 ? 'text-blue-600' : 'text-red-600'}`}>{new Intl.NumberFormat().format((dailyStats.income - dailyStats.expense)*30)}</td>
                                                    <td className={`py-3 ${dailyStats.income - dailyStats.expense >= 0 ? 'text-blue-600' : 'text-red-600'}`}>{Math.round((dailyStats.details.totalIncome.yearly - dailyStats.details.totalExpense.yearly)/10000)}</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                            </div>

                            <button onClick={() => setIsAIModalOpen(true)} className="md:hidden w-full mb-4 px-4 py-3 bg-gradient-to-r from-indigo-500 to-blue-500 text-white rounded-xl font-bold shadow-md flex items-center justify-center gap-2 ai-pulse"><i className="ph-fill ph-sparkle"></i> AI è²¡å‹™é¡§å•è¨ºæ–·</button>

                            <CollapsibleSection title="åŸºç¤èˆ‡æ”¶å…¥" icon="ğŸ‘¤" isOpen={openSections.basic} onToggle={() => toggleSection('basic')}>
                                <NumberControl label="ç›®å‰å¹´é½¡" value={params.currentAge} onChange={v => setParams({...params, currentAge: v})} min={18} max={60} unit="æ­²" />
                                <NumberControl label="åˆå§‹è³‡ç”¢" value={params.currentAssets} onChange={v => setParams({...params, currentAssets: v})} min={-1000} max={5000} step={10} unit="è¬" />
                                <NumberControl label="é è¨ˆé€€ä¼‘" value={params.retireAge} onChange={v => setParams({...params, retireAge: v})} min={20} max={80} unit="æ­²" />
                                
                                {/* æ–°å¢é å‚™é‡‘è¨­å®š */}
                                <div className="flex items-center gap-2 mb-4">
                                    <div className="flex-1">
                                        <NumberControl label="é å‚™é‡‘(æœˆ)" value={params.emergencyFundMonths} onChange={v => setParams({...params, emergencyFundMonths: v})} min={0} max={24} step={0.5} unit="æœˆ" compact />
                                    </div>
                                    <div className="text-xs text-slate-500 font-bold bg-slate-100 px-3 py-2 rounded self-start mt-6">
                                         â‰ˆ {new Intl.NumberFormat().format(params.monthlyExpense * params.emergencyFundMonths)} è¬ (ä¾æœˆæ”¯å‡º)
                                    </div>
                                </div>

                                <div className="border-t pt-2 mt-2">
                                    <NumberControl label="æœˆè–ªæ”¶å…¥" value={params.monthlyIncome} onChange={v => setParams({...params, monthlyIncome: v})} min={0} max={50} step={0.5} unit="è¬" />
                                    <NumberControl label="å¹´çµ‚çé‡‘" value={params.bonusMonths} onChange={v => setParams({...params, bonusMonths: v})} min={0} max={24} step={0.5} unit="å€‹æœˆ" />
                                    <NumberControl label="è–ªè³‡æˆé•·" value={params.incomeGrowth} onChange={v => setParams({...params, incomeGrowth: v})} min={0} max={10} step={0.1} unit="%" />
                                    <NumberControl label="æŠ•è³‡å ±é…¬" subLabel="(åç›®)" value={params.investReturn} onChange={v => setParams({...params, investReturn: v})} min={-20} max={30} step={0.5} unit="%" />
                                </div>
                            </CollapsibleSection>

                            <CollapsibleSection title="ç”Ÿæ´»é–‹éŠ· (æ¯æ—¥ç´°é …)" icon="ğŸœ" isOpen={openSections.expense} onToggle={() => toggleSection('expense')}>
                                <div className="mb-4 bg-slate-50 p-3 rounded-lg border border-slate-200">
                                    <div className="flex justify-between items-center mb-2">
                                        <span className="text-sm font-bold text-slate-700 flex items-center gap-2"><i className="ph-fill ph-receipt"></i> æ¯æ—¥ç´°é …è¨ˆç®—</span>
                                        <label className="relative inline-flex items-center cursor-pointer"><input type="checkbox" checked={useDailyDetail} onChange={e => setUseDailyDetail(e.target.checked)} className="sr-only peer" /><div className="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label>
                                    </div>
                                    {useDailyDetail && (
                                        <div className="animate-fade-in space-y-2 mt-3">
                                            {dailyItems.map((item) => (
                                                <div key={item.id} className="flex gap-2 items-center">
                                                    <IMEInput value={item.name} onChange={e => {const newItems=[...dailyItems]; newItems.find(x=>x.id===item.id).name=e.target.value; setDailyItems(newItems);}} className="w-1/2 p-1 text-sm border rounded"/>
                                                    <input type="number" value={item.cost} onChange={e => {const newItems=[...dailyItems]; newItems.find(x=>x.id===item.id).cost=e.target.value; setDailyItems(newItems);}} className="w-1/4 p-1 text-sm border rounded text-right"/>
                                                    <button onClick={() => setDailyItems(dailyItems.filter(i=>i.id!==item.id))} className="w-8 text-slate-400 hover:text-red-500">Ã—</button>
                                                </div>
                                            ))}
                                            <button onClick={() => setDailyItems([...dailyItems, {id:Date.now(), name:'', cost:0}])} className="w-full py-1 text-xs text-blue-600 border border-blue-200 rounded hover:bg-blue-50 mt-2">+ æ–°å¢</button>
                                            <AIBudgetOptimizer dailyItems={dailyItems} onOptimize={() => {}} />
                                        </div>
                                    )}
                                </div>
                                <NumberControl label="æœˆç”Ÿæ´»è²»" subLabel={useDailyDetail ? "(è‡ªå‹•è¨ˆç®—)" : ""} value={params.monthlyExpense} onChange={v => setParams({...params, monthlyExpense: v})} min={1} max={30} step={0.5} unit="è¬" readOnly={useDailyDetail}/>
                                <NumberControl label="é€šè†¨ç‡" value={params.inflationRate} onChange={v => setParams({...params, inflationRate: v})} min={0} max={10} step={0.1} unit="%" />
                            </CollapsibleSection>

                            <CollapsibleSection title="æˆ¿ç”¢æŠ•è³‡" icon="ğŸ " isOpen={openSections.house} onToggle={() => toggleSection('house')} colorClass="bg-purple-50/50" headerClass="text-purple-800">
                                <AddItemBox title="æ–°å¢æˆ¿ç”¢" onAdd={addProperty} disabled={!newProperty.name || !newProperty.price} footer={`ğŸ’¡ ä¾æœˆè–ª 33% è² æ“”å»ºè­°æˆ¿åƒ¹ä¸Šé™ ${suggestedHousePrice} è¬`}>
                                    <IMEInput placeholder="åç¨±" value={newProperty.name} onChange={e => setNewProperty({...newProperty, name: e.target.value})} className="w-full px-2 py-2 border rounded text-sm mb-2"/>
                                    <div className="grid grid-cols-2 gap-2 mb-2"><div><label className="text-xs text-slate-500">ç¸½åƒ¹(è¬)</label><input type="number" step="0.01" value={newProperty.price} onChange={e => setNewProperty({...newProperty, price: e.target.value})} className="w-full px-2 py-2 border rounded text-sm"/></div><div><label className="text-xs text-slate-500">è³¼è²·æ­²æ•¸</label><input type="number" value={newProperty.buyAge} onChange={e => setNewProperty({...newProperty, buyAge: e.target.value})} className="w-full px-2 py-2 border rounded text-sm"/></div></div>
                                    {/* é¡¯ç¤ºé©åˆè³¼å±‹å»ºè­° */}
                                    {suitableBuyAge && (
                                        <div className="text-xs text-purple-600 font-bold mb-2 bg-purple-50 p-2 rounded">
                                            <i className="ph-fill ph-magic-wand"></i> ä¾ç›®å‰å„²è“„é€Ÿåº¦ï¼Œé è¨ˆ {suitableBuyAge} æ­²å¯å­˜åˆ°é ­æœŸæ¬¾
                                        </div>
                                    )}
                                    <div className="grid grid-cols-3 gap-2 mb-2"><div><label className="text-xs text-slate-500">é ­æœŸ(%)</label><input type="number" value={newProperty.downPayment} onChange={e => setNewProperty({...newProperty, downPayment: e.target.value})} className="w-full px-2 py-2 border rounded text-sm"/></div><div><label className="text-xs text-slate-500">å¹´é™</label><input type="number" value={newProperty.loanTerm} onChange={e => setNewProperty({...newProperty, loanTerm: e.target.value})} className="w-full px-2 py-2 border rounded text-sm"/></div><div><label className="text-xs text-slate-500">åˆ©ç‡</label><input type="number" value={newProperty.rate} onChange={e => setNewProperty({...newProperty, rate: e.target.value})} className="w-full px-2 py-2 border rounded text-sm"/></div></div>
                                </AddItemBox>
                                <div className="space-y-2">{properties.map(p => (<div key={p.id} className="bg-white p-2 border rounded text-sm shadow-sm relative"><div className="font-bold text-purple-700 flex justify-between pr-6"><span>{p.name} <span className="text-xs font-normal text-slate-500">({p.buyAge}æ­²è²·)</span></span><span className="text-xs text-slate-400">{p.price}è¬</span></div><div className="mt-1 text-xs text-slate-500 flex gap-3"><span>æœˆä»˜: {new Intl.NumberFormat().format(calculateLoan(p.price, p.downPayment, p.loanTerm, p.rate).monthly)}</span><span>æ—¥å‡: {new Intl.NumberFormat().format(calculateLoan(p.price, p.downPayment, p.loanTerm, p.rate).daily)}</span></div><button onClick={() => removeProperty(p.id)} className="absolute top-2 right-2 text-slate-400 hover:text-red-500">Ã—</button></div>))}</div>
                            </CollapsibleSection>

                            <CollapsibleSection title="å­å¥³é¤Šè‚²" icon="ğŸ‘¶" isOpen={openSections.child} onToggle={() => toggleSection('child')} colorClass="bg-orange-50/50" headerClass="text-orange-800">
                                <AddItemBox title="æ–°å¢å­å¥³" onAdd={addChild} disabled={false}><div className="flex gap-2"><IMEInput placeholder="åå­—" value={newChild.name} onChange={e => setNewChild({...newChild, name: e.target.value})} className="w-2/3 px-2 py-2 border rounded text-sm"/><div className="w-1/3 flex items-center"><input type="number" placeholder="å‡ºç”Ÿæ­²" value={newChild.birthAge} onChange={e => setNewChild({...newChild, birthAge: parseInt(e.target.value)})} className="w-full px-2 py-2 border rounded text-sm text-center"/></div></div></AddItemBox>
                                <div className="space-y-3">{childrenList.map(child => (<div key={child.id} className="bg-white p-3 border rounded text-sm shadow-sm relative"><div className="flex justify-between items-center mb-2"><div className="font-bold text-orange-700">{child.name}</div><div className="text-xs text-orange-500">æ­¤æ™‚æˆ‘ {child.birthAge} æ­²</div></div><div className="space-y-1">{child.stages.map(stage => (<div key={stage.id} className="flex items-center gap-2 text-xs"><span className="w-16 truncate text-slate-500" title={stage.name}>{stage.name}</span><div className="flex items-center bg-slate-50 rounded px-1"><input type="number" value={stage.duration} onChange={e => updateChildStage(child.id, stage.id, 'duration', parseFloat(e.target.value))} className="w-8 bg-transparent text-center outline-none border-b border-slate-300"/><span className="text-slate-400">å¹´</span></div><div className="flex-1 flex items-center bg-slate-50 rounded px-1"><input type="number" value={stage.cost} onChange={e => updateChildStage(child.id, stage.id, 'cost', parseFloat(e.target.value))} className="w-full bg-transparent text-right outline-none border-b border-slate-300"/><span className="text-slate-400 ml-1">è¬/æœˆ</span></div></div>))}</div><button onClick={() => removeChild(child.id)} className="absolute top-2 right-2 text-slate-400 hover:text-red-500">Ã—</button></div>))}</div>
                            </CollapsibleSection>

                            <CollapsibleSection title="è»Šè¼› & å­è¦ª & å…¶ä»–" icon="âš™ï¸" isOpen={openSections.car} onToggle={() => toggleSection('car')} colorClass="bg-gray-50" headerClass="text-gray-800">
                                <div className="space-y-4">
                                    <div className="border-l-4 border-teal-500 pl-2">
                                        <div className="flex justify-between mb-2 text-sm font-bold text-teal-700"><span>å­è¦ªè²»</span><input type="checkbox" checked={params.hasParents} onChange={e => setParams({...params, hasParents: e.target.checked})} className="accent-teal-600"/></div>
                                        {params.hasParents && <div className="space-y-2"><NumberControl label="æœˆå­è¦ª" value={params.parentsMonthlyCost} onChange={v => setParams({...params, parentsMonthlyCost: v})} min={0.5} max={10} step={0.5} unit="è¬" compact /><div className="flex gap-2"><NumberControl label="é–‹å§‹æ­²" value={params.parentsStartAge} onChange={v => setParams({...params, parentsStartAge: v})} min={20} max={60} compact /><NumberControl label="çµæŸæ­²" value={params.parentsEndAge} onChange={v => setParams({...params, parentsEndAge: v})} min={50} max={90} compact /></div></div>}
                                    </div>
                                    <div className="border-l-4 border-pink-500 pl-2">
                                        <div className="flex justify-between mb-2 text-sm font-bold text-pink-700"><span>å©šå§»</span><input type="checkbox" checked={params.hasMarriage} onChange={e => setParams({...params, hasMarriage: e.target.checked})} className="accent-pink-600"/></div>
                                        {params.hasMarriage && <div className="flex gap-2"><NumberControl label="çµå©šæ­²" value={params.marriageAge} onChange={v => setParams({...params, marriageAge: v})} min={20} max={60} compact /><NumberControl label="èŠ±è²»" value={params.marriageCost} onChange={v => setParams({...params, marriageCost: v})} min={10} max={300} unit="è¬" compact /></div>}
                                    </div>
                                    <div className="border-l-4 border-blue-500 pl-2">
                                        <div className="text-sm font-bold text-blue-700 mb-2">è»Šè¼›è²¸æ¬¾</div>
                                        <AddItemBox title="æ–°å¢è»Šè¼›" onAdd={addCar} disabled={!newCar.name || !newCar.price}>
                                            <IMEInput placeholder="åç¨±" value={newCar.name} onChange={e => setNewCar({...newCar, name: e.target.value})} className="w-full px-2 py-1 border rounded text-xs mb-1"/>
                                            <div className="grid grid-cols-3 gap-1">
                                                <div><label className="text-[10px] text-slate-500 block">åƒ¹æ ¼(è¬)</label><input type="number" step="0.01" value={newCar.price} onChange={e => setNewCar({...newCar, price: e.target.value})} className="w-full px-1 border rounded text-xs"/></div>
                                                <div><label className="text-[10px] text-slate-500 block">è³¼å…¥æ­²æ•¸</label><input type="number" value={newCar.buyAge} onChange={e => setNewCar({...newCar, buyAge: e.target.value})} className="w-full px-1 border rounded text-xs"/></div>
                                                <div><label className="text-[10px] text-slate-500 block">è²¸æ¬¾å¹´é™</label><input type="number" value={newCar.loanTerm} onChange={e => setNewCar({...newCar, loanTerm: e.target.value})} className="w-full px-1 border rounded text-xs"/></div>
                                            </div>
                                        </AddItemBox>
                                        <div className="space-y-2 mt-2">
                                            {cars.map(c => (
                                                <div key={c.id} className="bg-white p-2 border rounded text-xs relative">
                                                    <div className="flex items-center gap-1 mb-1">
                                                        <input type="text" value={c.name} onChange={e => updateCar(c.id, 'name', e.target.value)} className="font-bold border-b border-dashed border-slate-300 w-full outline-none"/>
                                                        <button onClick={() => removeCar(c.id)} className="text-red-400 ml-1">Ã—</button>
                                                    </div>
                                                    <div className="grid grid-cols-3 gap-1">
                                                        <div><label className="text-[10px] text-slate-400">åƒ¹æ ¼</label><input type="number" step="0.01" value={c.price} onChange={e => updateCar(c.id, 'price', e.target.value)} className="w-full border rounded px-1"/></div>
                                                        <div><label className="text-[10px] text-slate-400">è³¼å…¥æ­²</label><input type="number" value={c.buyAge} onChange={e => updateCar(c.id, 'buyAge', e.target.value)} className="w-full border rounded px-1"/></div>
                                                        <div><label className="text-[10px] text-slate-400">è²¸æ¬¾å¹´</label><input type="number" value={c.loanTerm} onChange={e => updateCar(c.id, 'loanTerm', e.target.value)} className="w-full border rounded px-1"/></div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </CollapsibleSection>

                            <CollapsibleSection title="è¢«å‹•æ”¶å…¥ & è‡ªè¨‚" icon="ğŸ’¸" isOpen={openSections.custom} onToggle={() => toggleSection('custom')}>
                                <div className="space-y-4">
                                    <AddItemBox title="æ–°å¢è¢«å‹•æ”¶å…¥" onAdd={addPassiveIncome} disabled={!newPassive.name || !newPassive.amount}><div className="flex gap-2 mb-1"><IMEInput placeholder="åç¨±" value={newPassive.name} onChange={e => setNewPassive({...newPassive, name: e.target.value})} className="w-2/3 px-2 py-1 border rounded text-xs"/><input type="number" step="0.01" placeholder="è¬" value={newPassive.amount} onChange={e => setNewPassive({...newPassive, amount: e.target.value})} className="w-1/3 px-2 py-1 border rounded text-xs"/></div><div className="flex gap-2"><input type="number" placeholder="èµ·æ­²" value={newPassive.startAge} onChange={e => setNewPassive({...newPassive, startAge: e.target.value})} className="w-1/3 px-1 border rounded text-xs"/><input type="number" placeholder="è¿„æ­²" value={newPassive.endAge} onChange={e => setNewPassive({...newPassive, endAge: e.target.value})} className="w-1/3 px-1 border rounded text-xs"/><select value={newPassive.frequency} onChange={e => setNewPassive({...newPassive, frequency: e.target.value})} className="w-1/3 text-xs bg-white border rounded"><option value="monthly">æœˆ</option><option value="yearly">å¹´</option></select></div></AddItemBox>
                                    <div className="space-y-1">{passiveIncomes.map(p => (<div key={p.id} className="flex justify-between bg-white p-1 border rounded text-xs text-green-700"><span>{p.name} (+{p.amount})</span><button onClick={() => removePassiveIncome(p.id)} className="text-red-400">Ã—</button></div>))}</div>
                                    
                                    <AddItemBox title="è‡ªè¨‚æ”¯å‡º" onAdd={addCustomExpense} disabled={!newCustomExp.name || !newCustomExp.amount}>
                                        <div className="flex gap-2 mb-1">
                                            <IMEInput placeholder="é …ç›®" value={newCustomExp.name} onChange={e => setNewCustomExp({...newCustomExp, name: e.target.value})} className="w-2/3 px-2 py-1 border rounded text-xs"/>
                                            <input type="number" step="0.01" placeholder="è¬" value={newCustomExp.amount} onChange={e => setNewCustomExp({...newCustomExp, amount: e.target.value})} className="w-1/3 px-2 py-1 border rounded text-xs"/>
                                        </div>
                                        <div className="flex gap-2">
                                            <input type="number" placeholder="èµ·æ­²" value={newCustomExp.startAge} onChange={e => setNewCustomExp({...newCustomExp, startAge: e.target.value})} className="w-1/3 px-1 border rounded text-xs"/>
                                            <select value={newCustomExp.frequency} onChange={e => setNewCustomExp({...newCustomExp, frequency: e.target.value})} className="w-1/3 text-xs bg-white border rounded">
                                                <option value="once">å–®æ¬¡</option>
                                                <option value="weekly">æ¯é€±</option>
                                                <option value="monthly">æ¯æœˆ</option>
                                                <option value="yearly">æ¯å¹´</option>
                                            </select>
                                        </div>
                                    </AddItemBox>
                                    
                                    {/* è‡ªè¨‚æ”¯å‡º - å¯ç·¨è¼¯å€å¡Š */}
                                    <div className="space-y-2">
                                        {customExpenses.map(p => (
                                            <div key={p.id} className="bg-white p-2 border rounded text-xs relative shadow-sm">
                                                <button onClick={() => removeCustomExpense(p.id)} className="absolute top-1 right-2 text-slate-400 hover:text-red-500 text-lg">Ã—</button>
                                                <div className="mb-2 pr-6">
                                                    <label className="text-[10px] text-slate-400 block">é …ç›®åç¨±</label>
                                                    <input type="text" value={p.name} onChange={e => updateCustomExpense(p.id, 'name', e.target.value)} className="w-full border-b border-slate-200 outline-none font-bold text-red-700"/>
                                                </div>
                                                <div className="grid grid-cols-4 gap-2">
                                                    <div><label className="text-[10px] text-slate-400 block">é‡‘é¡(è¬)</label><input type="number" step="0.01" value={p.amount} onChange={e => updateCustomExpense(p.id, 'amount', e.target.value)} className="w-full border rounded px-1"/></div>
                                                    <div>
                                                        <label className="text-[10px] text-slate-400 block">é »ç‡</label>
                                                        <select value={p.frequency} onChange={e => updateCustomExpense(p.id, 'frequency', e.target.value)} className="w-full border rounded px-1">
                                                            <option value="once">å–®æ¬¡</option>
                                                            <option value="weekly">æ¯é€±</option>
                                                            <option value="monthly">æ¯æœˆ</option>
                                                            <option value="yearly">æ¯å¹´</option>
                                                        </select>
                                                    </div>
                                                    <div><label className="text-[10px] text-slate-400 block">é–‹å§‹æ­²</label><input type="number" value={p.startAge} onChange={e => updateCustomExpense(p.id, 'startAge', e.target.value)} className="w-full border rounded px-1"/></div>
                                                    <div><label className="text-[10px] text-slate-400 block">çµæŸæ­²</label><input type="number" value={p.endAge || p.startAge} onChange={e => updateCustomExpense(p.id, 'endAge', e.target.value)} disabled={p.frequency === 'once'} className={`w-full border rounded px-1 ${p.frequency==='once' ? 'bg-slate-100 text-slate-300':''}`}/></div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </CollapsibleSection>

                        </div>
                    </div>

                    <main className="flex-1 bg-slate-100 p-4 lg:p-6 overflow-y-auto w-full">
                        <div className="max-w-5xl mx-auto space-y-6">
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200"><div className="text-xs text-slate-400 font-bold uppercase">ç¸½æ”¶å…¥ (å«è¢«å‹•)</div><div className="text-lg font-bold text-slate-800">{new Intl.NumberFormat().format(Math.round(simulation.totalEarned/10000))} è¬</div></div>
                                <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200"><div className="text-xs text-slate-400 font-bold uppercase">è¢«å‹•æ”¶å…¥ä½”æ¯”</div><div className="text-lg font-bold text-green-600">{simulation.totalEarned > 0 ? ((simulation.totalPassive / simulation.totalEarned)*100).toFixed(1) : 0}%</div></div>
                                <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200"><div className="text-xs text-slate-400 font-bold uppercase">æœ€é«˜è³‡ç”¢</div><div className="text-lg font-bold text-blue-600">{new Intl.NumberFormat().format(Math.round(Math.max(...simulation.dataPoints)))} è¬</div></div>
                                <div className={`bg-white p-4 rounded-xl shadow-sm border ${simulation.bankruptAge ? 'border-red-300 bg-red-50' : 'border-slate-200'}`}><div className="text-xs text-slate-400 font-bold uppercase">ç ´ç”¢é¢¨éšª</div><div className={`text-lg font-bold ${simulation.bankruptAge ? 'text-red-600' : 'text-slate-800'}`}>{simulation.bankruptAge ? `${simulation.bankruptAge} æ­²` : 'ç„¡'}</div></div>
                            </div>
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div className="lg:col-span-2 bg-white p-4 rounded-2xl shadow-sm border border-slate-200 h-[400px] flex flex-col"><h3 className="text-sm font-bold text-slate-600 mb-4 flex items-center gap-2"><i className="ph-bold ph-chart-line-up"></i> è³‡ç”¢ç´¯ç© (å¯¦è³ªè³¼è²·åŠ›)</h3><div className="flex-1 relative w-full"><div className="chart-container"><FinanceChart mainSimulation={simulation} comparisonSimulations={comparisonSimulations} /></div></div></div>
                                <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 h-[400px] flex flex-col"><h3 className="text-sm font-bold text-slate-600 mb-4 flex items-center gap-2"><i className="ph-bold ph-chart-pie-slice"></i> ç”Ÿæ¶¯æ”¯å‡º (åç›®)</h3><div className="flex-1 relative w-full"><div className="chart-container"><ExpensePieChart data={simulation.expenseStats} customBreakdown={simulation.customBreakdown} /></div></div></div>
                            </div>
                        </div>
                    </main>
                </div>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>
